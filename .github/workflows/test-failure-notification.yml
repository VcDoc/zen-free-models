name: Test Failure Notification

on:
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  always-fail:
    runs-on: ubuntu-latest
    steps:
      - name: Intentionally fail
        run: exit 1

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: always-fail
    if: failure()
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Extract and run notification script
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const yaml = require('js-yaml');

            // Read the main workflow file
            const workflowContent = fs.readFileSync('.github/workflows/update-zen-free-models.yml', 'utf8');
            const workflow = yaml.load(workflowContent);

            // Extract the script from notify-on-failure job
            const notifyJob = workflow.jobs['notify-on-failure'];
            const scriptStep = notifyJob.steps.find(s => s.name === 'Create failure issue');
            const script = scriptStep.with.script;

            // Execute the extracted script
            eval(script);
