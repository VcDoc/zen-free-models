name: Update Zen Free Models

on:
  schedule:
    - cron: '0 5 * * *'  # Midnight EST (UTC-5)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-models:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: 'scraper/package.json'

      - name: Install dependencies
        working-directory: ./scraper
        run: pnpm install

      - name: Restore Stagehand cache
        uses: actions/cache@v4
        with:
          path: .stagehand-cache
          key: stagehand-cache-${{ runner.os }}-${{ hashFiles('scraper/src/index.ts') }}
          restore-keys: |
            stagehand-cache-${{ runner.os }}-

      - name: Run scraper
        working-directory: ./scraper
        env:
          BROWSERBASE_API_KEY: ${{ secrets.BROWSERBASE_API_KEY }}
          BROWSERBASE_PROJECT_ID: ${{ secrets.BROWSERBASE_PROJECT_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: pnpm start

      - name: Run tests
        working-directory: ./scraper
        run: pnpm test

      - name: Update README with current models
        run: |
          # Extract model IDs from JSON and format as markdown list
          MODELS=$(node -e "
            const data = require('./zen-free-models.json');
            data.modelIds.forEach(id => console.log('- \`' + id + '\`'));
          ")

          # Update README section between markers
          awk -v models="$MODELS" '
            /^## Free Models \(Current\)/ {
              print
              getline  # skip empty line
              print ""
              print models
              # Skip old model list until next section
              while ((getline line) > 0 && line !~ /^## /) {}
              print ""
              print line
              next
            }
            { print }
          ' README.md > README.md.tmp && mv README.md.tmp README.md

      - name: Check for changes
        id: changed
        run: |
          # Check both the output JSON and the cache
          git add -A
          git diff --cached --quiet && echo "changed=false" >> $GITHUB_OUTPUT || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push
        if: steps.changed.outputs.changed == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add zen-free-models.json .stagehand-cache README.md
          git commit -m "Update free Zen models - $(date -u +%Y-%m-%d)"
          git push
